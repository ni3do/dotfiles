# If available, source the system-wide bashrc
if [ -f /etc/zshrc ]; then
  . /etc/zshrc
fi

# History options should be set in .zshrc and after oh-my-zsh sourcing.
# See https://github.com/nix-community/home-manager/issues/177.
HISTSIZE="10000"
SAVEHIST="10000"

HISTFILE="$HOME/.zsh_history"
mkdir -p "$(dirname "$HISTFILE")"

## Open buffer line in editor
autoload -Uz edit-command-line
zle -N edit-command-line
bindkey '^x^e' edit-command-line

# Expands history expressions like !! or !$ when you press space
bindkey ' ' magic-space

# Enable zmv
autoload -Uz zmv

# Usage examples:
# zmv '(*).log' '$1.txt'           # Rename .log to .txt
# zmv -w '*.log' '*.txt'           # Same thing, simpler syntax
# zmv -n '(*).log' '$1.txt'        # Dry run (preview changes)
# zmv -i '(*).log' '$1.txt'        # Interactive mode (confirm each)

# Copy current command buffer to clipboard (macOS)
function copy-buffer-to-clipboard() {
  echo -n "$BUFFER" | pbcopy
  zle -M "Copied to clipboard"
}
zle -N copy-buffer-to-clipboard
bindkey '^X^C' copy-buffer-to-clipboard


##### Zshenv #####
# use vim as the editor
export EDITOR=nvim

export PATH="$HOME/repo/simonwachter-dotfiles/bin:$PATH"

# Starship
export STARSHIP_CONFIG=~/.config/starship/starship.toml

# FZF
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow'
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

##### Aliases #####
# Git
alias gc="git commit -m"
alias gca="git commit --all -m 'auto-commit'"
alias gp="git push"
alias gpu="git pull"
alias gs="git status"
alias glog="git log --graph --topo-order --pretty='%w(100,0,6)%C(yellow)%h%C(bold)%C(black)%d %C(cyan)%ar %C(green)%an%n%C(bold)%C(white)%s %N' --abbrev-commit"
alias gdiff="git diff"
alias gco="git checkout"
alias gb='git branch'
alias gba='git branch -a'
alias gadd='git add'
alias ga='git add -p'
alias gcoall='git checkout -- .'
alias gr='git remote'
alias gre='git reset'

# Nvim
alias vi=nvim

# Claude Code
alias c=claude

# Eza
alias l="eza -l --icons --git -a"
alias lt="eza --tree --level=2 --long --icons --git"
alias ltree="eza --tree --level=2  --icons --git"

# bat
alias cat="bat --paging=never"
alias ocat="/bin/cat"

# Yazi wrapper
function y() {
	local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
	yazi "$@" --cwd-file="$tmp"
	IFS= read -r -d '' cwd < "$tmp"
	[ -n "$cwd" ] && [ "$cwd" != "$PWD" ] && builtin cd -- "$cwd"
	rm -f -- "$tmp"
}

##### Zshrc #####
eval "$(starship init zsh)"
eval "$(zoxide init zsh)"

##### Antigen #####
source ~/.config/antigen/antigen.zsh

# Keep antigen/zcache artifacts in XDG cache (not the repo root).
_antigen_cache_root="${XDG_CACHE_HOME:-$HOME/.cache}/antigen"
mkdir -p "$_antigen_cache_root"
export ANTIGEN_CACHE="$_antigen_cache_root/.antigen.zsh"
export ZCACHEFILE="$_antigen_cache_root/zcache.zsh"

antigen bundle zsh-users/zsh-syntax-highlighting
antigen bundle zsh-users/zsh-autosuggestions
antigen bundle "MichaelAquilina/zsh-you-should-use"
antigen bundle Aloxaf/fzf-tab

antigen apply
export PATH="$HOME/.local/bin:$PATH"
